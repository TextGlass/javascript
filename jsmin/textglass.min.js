/* TextGlass JS client 1.0.0
 * http://textglass.org
 * Copyright (c) 2015 TextGlass
 * License: Apache 2.0
 */
var textglass=function(f){function p(a,b){f.debug(0,"loadError()",b);0<a.parent.status&&a.parent.callback("error",b);a.status=-1;a.parent.status=-1}function r(a,b,c){var d=a.attribute.attributes[b];if(d){for(var g=t(d,c);d.parentId;){d=a.attribute.attributes[d.parentId];if(!d)break;var e=t(d,c),f;for(f in e)g[f]||(g[f]=e[f])}g.patternId=b;return g}return{patternId:b}}function t(a,b){var c={},d;for(d in a.attributes)c[d]=a.attributes[d];for(d in a.attributeTransformers){for(var g=a.attributeTransformers[d],
e=b,f=0;f<g.compiledTransformers.length;f++)if(e=(0,g.compiledTransformers[f])(e),"undefined"===typeof e){e=g.defaultValue||"";break}c[d]=e}return c}function z(a,b){for(var c=-1,d=0;d<a.patternTokens.length;d++){var g=b.indexOf(a.patternTokens[d]);if(-1===g&&("SimpleAnd"===a.patternType||"SimpleOrderedAnd"===a.patternType))return!1;if(0<=g&&"Simple"===a.patternType)return!0;if("SimpleOrderedAnd"===a.patternType){if(g<=c)return!1;c=g}}return"Simple"!==a.patternType}function A(a){var b=a.rankValue||
0;if("Weak"===a.rankType)b+=1E5;else if("Strong"===a.rankType)return 1E7;return b}function w(a,b){for(var c=0,d=0;d<a.patternTokens.length;d++){var g=a.patternTokens[d];0<=b.indexOf(g)&&(c+=g.length)}return c}function x(a){a.compiledTransformers=[];for(var b=0;b<a.transformers.length;b++){var c=a.transformers[b],d=B(c);if(!d)return{error:!0,msg:"Transformer not found: "+c.type};a.compiledTransformers.push(d)}}function B(a){if("LowerCase"===a.type)return C;if("UpperCase"===a.type)return D;if("ReplaceFirst"===
a.type)return function(b){var c=a.parameters.find,d=a.parameters.replaceWith,g=b.indexOf(c);b=0<g?b.substring(0,g)+d+b.substring(g+c.length):b;return b};if("ReplaceAll"===a.type)return function(b){for(var c=a.parameters.find,d=a.parameters.replaceWith,g=b.indexOf(c);0<=g;)b=b.substring(0,g)+d+b.substring(g+c.length),g=b.indexOf(c,g+d.length);return b};if("SplitAndGet"===a.type)return function(b){var c=a.parameters.get;b=y(b,[a.parameters.delimiter]);-1===c&&(c=b.length-1);return b[c]};if("Substring"===
a.type)return function(b){var c=a.parameters.start,d=a.parameters.maxLength,d=d||-1;b=c>=b.length?void 0:0<=d&&d+c<=b.length?b.substring(c,d+c):b.substring(c);return b};if("IsNumber"===a.type)return E}function C(a){return a.toLowerCase()}function D(a){return a.toUpperCase()}function E(a){if(!isNaN(parseFloat(a))&&isFinite(a))return a}function y(a,b){b=b||[];var c=[],d=0,g=0,e=0;a:for(;d<a.length;){var f=0;b:for(;f<b.length;f++){var l=b[f],k;for(k=0;k<l.length;k++)if(d+k>=a.length||a.charAt(d+k)!==
l.charAt(k))continue b;0<e-g&&c.push(a.substring(g,e));g=e=d+=k;continue a}d++;e++}0<e-g&&c.push(a.substring(g,e));return c}f.version="1.0.0";f.debugLevel=f.debugLevel||-1;f.domains={};f.debug=f.debug||function(a,b){if(a<=f.debugLevel){var c=Array.prototype.slice.call(arguments,0);c[0]="TextGlass: ";for(var d=0;d<a;d++)c[0]+="  ";console.log.apply(console,c)}};f.domainReady=function(a,b,c){};f.loadURLs=function(a,b,c,d,g){f.debug(1,"patternURL:",a);f.debug(1,"attributeURL:",b);f.debug(1,"patternPatchURL:",
c);f.debug(1,"attributePatchURL:",d);g=g||f.domainReady;if(a){var e={status:1};e.callback=g;e.start=Date.now();e.pattern={};e.attribute={};e.patternPatch={};e.attributePatch={};f.getURL(e.pattern,e,a);b&&f.getURL(e.attribute,e,b);c&&f.getURL(e.patternPatch,e,c);d&&f.getURL(e.attributePatch,e,d)}else g("error","no pattern file")};f.getURL=function(a,b,c,d){f.debug(1,"Getting url:",c);a.url=c;a.status=1;a.parent=b;a.request=new XMLHttpRequest;a.request.open("GET",a.url,!0);a.request.onload=function(){if(200<=
a.request.status&&300>a.request.status){try{a.json=JSON.parse(a.request.responseText)}catch(c){p(a,"JSON parse error: "+c);return}if(1!==a.json.TextGlassSpecVersion)p(a,"Invalid TextGlassSpecVersion found");else if(a.status=2,d)d(a.parent);else a:{var b=a.parent;f.debug(2,"readyToLoad()");if(!(0>b.status)){for(var e in b){var h=b[e];if(h.url&&2!==h.status)break a}b.pattern.json._diff=Date.now()-b.start;e=f.loadObjects(b.pattern.json,b.attribute.json,b.patternPatch.json,b.attributePatch.json);!e||
e.error?b.callback("error",e?e.msg:"Unknown error",e.domain?e.domain:void 0):b.callback("ready",e.msg,e.domain)}}}else p(a,"Bad response code "+a.request.status+" for "+a.url)};a.request.onerror=function(){p(a,"Error for "+a.url)};a.request.send()};f.loadObjects=function(a,b,c,d){var g=Date.now(),e=a.domain,h=a.domainVersion;if(!a||"pattern"!==a.type||!a.patternSet||1!==a.TextGlassSpecVersion)return{error:!0,msg:"Invalid pattern file"};if(b&&("attribute"!==b.type||b.domain!==e||b.domainVersion!==
h||!b.attributes||1!==b.TextGlassSpecVersion))return{error:!0,msg:"Invalid attribute file"};if(c&&("patternPatch"!==c.type||c.domain!==e||c.domainVersion!==h||!c.patternSet||1!==c.TextGlassSpecVersion))return{error:!0,msg:"Invalid pattern patch file"};if(d&&("attributePatch"!==d.type||d.domain!==e||d.domainVersion!==h||!d.attributes||1!==d.TextGlassSpecVersion))return{error:!0,msg:"Invalid attribute patch file"};f.debug(1,"Loading:",e,"Version:",h);if(f.domains[e])return{error:!0,msg:"Domain already loaded",
domain:e};a.inputParser||(a.inputParser={});c&&c.inputParser&&(c.inputParser.transformers&&(a.inputParser.transformers=c.inputParser.transformers),c.inputParser.tokenSeperators&&(a.inputParser.tokenSeperators=c.inputParser.tokenSeperators),c.inputParser.ngramConcatSize&&(a.inputParser.ngramConcatSize=c.inputParser.ngramConcatSize));if(a.inputParser.transformers&&0<a.inputParser.transformers.length){var l=x(a.inputParser);if(l)return l}a.patternIndex={};for(var k=0;2>k;k++){l=[];!k&&a.patternSet.patterns?
l=a.patternSet.patterns:c&&c.patternSet.patterns&&(l=c.patternSet.patterns);for(var v=0;v<l.length;v++){var m=l[v];if("Strong"!==m.rankType&&"Weak"!==m.rankType&&"None"!==m.rankType)return{error:!0,msg:"Invalid rankType: "+m.rankType};if("Simple"!==m.patternType&&"SimpleAnd"!==m.patternType&&"SimpleOrderedAnd"!==m.patternType)return{error:!0,msg:"Invalid patternType: "+m.patternType};m.rank=A(m);f.debug(3,"Found pattern:",m.patternId,"tokens:",m.patternTokens,"rank:",m.rank);for(var p=0;p<m.patternTokens.length;p++){var r=
m.patternTokens[p],u=a.patternIndex[r];u||(u=[],a.patternIndex[r]=u);u.push(m)}}}c&&c.patternSet.defaultId&&(a.patternSet.defaultId=c.patternSet.defaultId);k=0;b||(b={});b.attributes||(b.attributes={});if(a.attributes)for(var n in a.attributes)b.attributes[n]||(b.attributes[n]=a.attributes[n]);if(c&&c.attributes)for(n in c.attributes)b.attributes[n]||(b.attributes[n]=c.attributes[n]);if(d)for(n in d.attributes)b.attributes[n]=d.attributes[n];if(b)for(n in b.attributes){c=b.attributes[n];f.debug(3,
"Found attribute:",n,"attributes:",!!c.attributes,"attributeTransformers:",!!c.attributeTransformers);if(c.attributeTransformers)for(var t in c.attributeTransformers)if(l=x(c.attributeTransformers[t]))return l;k++}var q={};q.name=e;q.version=h;q.pattern=a;q.attribute=b;q.classify=function(a){return f.classify(q,a)};b=Date.now()-g;q.msg="Loaded "+e+", version: "+h+", patterns: "+q.pattern.patternSet.patterns.length+", attributes: "+k+", time: "+b+"ms"+(a._diff?" ("+a._diff+"ms)":"");return f.domains[e]=
q};f.classify=function(a,b){f.debug(1,"classify() domain",a.name);f.debug(1,"classify() input",b);if(a.pattern.inputParser.compiledTransformers)for(var c=0;c<a.pattern.inputParser.compiledTransformers.length;c++)if(b=(0,a.pattern.inputParser.compiledTransformers[c])(b),"undefined"===typeof b)throw"Transformer error on input";f.debug(2,"classify() transformed",b);var d=y(b,a.pattern.inputParser.tokenSeperators);f.debug(2,"classify() tokens",d);for(var g=[],e=a.pattern.inputParser.ngramConcatSize||
1,c=0;c<d.length;c++){for(var h="",l=[],k=e;0<k&&c+e-k<d.length;k--)h+=d[c+e-k],l.unshift(h);g.push.apply(g,l)}f.debug(2,"classify() ngrams",g);d=[];e=[];h=void 0;for(c=0;c<g.length;c++)if(l=g[c],k=a.pattern.patternIndex[l]){d.push(l);for(var p=0;p<k.length;p++){var m=k[p];-1===e.indexOf(m)&&e.push(m)}f.debug(3,"Hit:",l,"candidates:",k)}if(!h)for(c=0;c<e.length;c++)g=e[c],z(g,d)&&(f.debug(2,"candidate:",g),h?g.rank>h.rank?h=g:g.rank===h.rank&&w(g,d)>w(h,d)&&(h=g):h=g);f.debug(2,"Winner:",h?h.patternId:
"null");return h?r(a,h.patternId,b):a.pattern.patternSet.defaultId?r(a,a.pattern.patternSet.defaultId,b):null};f.loaded=!0;return f}(textglass||{}),module=module||void 0;"undefined"!==typeof module&&"undefined"!==typeof module.exports&&(module.exports=textglass);
